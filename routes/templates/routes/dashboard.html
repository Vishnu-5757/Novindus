{% extends 'routes/base.html' %}

{% block content %}
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<style>
 
    #airport-network {
        width: 100%;
        height: 300px;
        border: 1px solid #ddd;
        background-color: #fafafa;
    }
</style>

<div class="container py-4">
    
    

    <div class="row g-4">
        
        <div class="col-lg-4">
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <strong>Live Network Diagram (Tree Structure)</strong>
                </div>
                <div class="card-body p-0">
                    <div id="airport-network"></div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
    <div class="card-header bg-secondary text-white">
        <strong>Admin: Add New Route</strong>
    </div>
    <div class="card-body p-3">
        <form method="post" id="admin-form">
            {% csrf_token %}
            
            <div class="mb-3">
    <label class="form-label fw-bold small text-muted text-uppercase d-block mb-2">Path Details</label>
    
    <div class="row g-2">
        
        <div class="col-4">
            <label class="small text-muted mb-1">Source</label>
            <div class="input-group input-group-sm">
                {{ form.source }} 
            </div>
        </div>

        <div class="col-4">
            <label class="small text-muted mb-1">Destination</label>
            <div class="input-group input-group-sm">
                {{ form.destination }}
            </div>
        </div>

        <div class="col-4">
            <label class="small text-muted mb-1">Direction</label>
            <div class="input-group input-group-sm">
                {{ form.direction }}
            </div>
        </div>

    </div>
</div>

            <hr class="text-muted">

            <div class="row g-2 mb-4">
                <div class="col-6">
                    <label class="form-label fw-bold small">Distance (km)</label>
                    {{ form.distance_km }}
                </div>
                <div class="col-6">
                    <label class="form-label fw-bold small">Duration (min)</label>
                    {{ form.duration_mins }}
                </div>
            </div>

            <button type="submit" name="add_route" class="btn btn-primary w-100 fw-bold">
                Add Route
            </button>
        </form>
    </div>
</div>
        </div>

        <div class="col-lg-8">

            <div class="card shadow-sm mb-4 border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span><strong>Q1: Find Nth Node</strong> (Left/Right Search)</span>
                </div>
                <div class="card-body bg-light">
                    <form method="get" class="row g-2 align-items-end">
                        <input type="hidden" name="search_nth" value="true">
                        
                        <div class="col-md-4">
                            <label class="form-label small">Start Airport</label>
                            <select name="start_node" class="form-select">
                                {% for airport in airports %}
                                <option value="{{ airport.code }}">{{ airport.code }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Direction</label>
                            <select name="direction" class="form-select">
                                <option value="LEFT">Left</option>
                                <option value="RIGHT">Right</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Steps (N)</label>
                            <input type="number" name="n_steps" class="form-control" value="1" min="1">
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">Find Node</button>
                        </div>
                    </form>

                    {% if nth_result %}
                    <div class="alert alert-primary mt-3 mb-0">
                        <strong>Result:</strong> {{ nth_result }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm mb-4 border-warning">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <span><strong>Q2: Longest Duration Route</strong></span>
                </div>
                <div class="card-body text-center">
                    {% if longest_route %}
                        <h3 class="display-6">
                            {{ longest_route.source.code }} 
                            &rarr; 
                            {{ longest_route.destination.code }}
                        </h3>
                        <p class="lead text-danger fw-bold">
                            {{ longest_route.duration_mins }} Minutes 
                            <span class="text-muted small">({{ longest_route.direction }})</span>
                        </p>
                    {% else %}
                        <p class="text-muted">No flight routes available.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm border-info">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <span><strong>Q3: Shortest Path</strong></span>
                </div>
                <div class="card-body bg-light">
                    <form method="get" class="row g-2 align-items-end">
                        <input type="hidden" name="search_path" value="true">

                        <div class="col-md-5">
                            <label class="form-label small">From</label>
                            <select name="path_start" class="form-select">
                                {% for airport in airports %}
                                <option value="{{ airport.code }}">{{ airport.code }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label small">To</label>
                            <select name="path_end" class="form-select">
                                {% for airport in airports %}
                                <option value="{{ airport.code }}">{{ airport.code }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-info text-white w-100">Go</button>
                        </div>
                    </form>

                    {% if shortest_path_result %}
                    <div class="alert alert-info mt-3 mb-0">
                        {% if shortest_path_result.path %}
                            <strong>Shortest Path:</strong>
                            {% for node in shortest_path_result.path %}
                                {{ node }} {% if not forloop.last %}&rarr;{% endif %}
                            {% endfor %}
                            <br>
                            <strong>Total Duration:</strong> {{ shortest_path_result.total_duration }} mins
                        {% else %}
                            {{ shortest_path_result }}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

<script type="text/javascript">
    // 1. Get JSON data passed from Django View
    var nodesArray = {{ graph_nodes|safe }};
    var edgesArray = {{ graph_edges|safe }};

    // 2. Setup Vis.js DataSets
    var nodes = new vis.DataSet(nodesArray);
    var edges = new vis.DataSet(edgesArray);

    // 3. Define the container
    var container = document.getElementById('airport-network');

    // 4. Data object
    var data = {
        nodes: nodes,
        edges: edges
    };

    // 5. Configuration Options (FORCES THE TREE STRUCTURE FROM THE PDF IMAGE)
    var options = {
        layout: {
            hierarchical: {
                enabled: true, // Ensure hierarchical layout is ON
                direction: "UD", // Up-Down direction (A at top)
                sortMethod: "directed", // Use graph direction for layout
                levelSeparation: 150,
                nodeSpacing: 200
            }
        },
        nodes: {
            borderWidth: 2,
            size: 30,
            font: { size: 14, face: "arial" }
        },
        edges: {
            width: 2,
            color: { color: '#333' },
            font: { size: 12, align: 'middle' },
            arrows: { to: { enabled: true, scaleFactor: 1 } },
            smooth: { type: 'cubicBezier' } // Nice curved lines
        },
        physics: false // Crucial: Disable physics so it stays in the neat tree layout
    };

    // 6. Initialize Network
    var network = new vis.Network(container, data, options);
</script>

{% endblock %}